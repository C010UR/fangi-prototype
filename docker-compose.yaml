services:
  nginx:
    image: nginx:1.27-alpine3.20
    container_name: mycelium-nginx
    ports:
      - "8000:8000"
    volumes:
      - ./backend:/app:delegated
      - ./shared:/app/shared:ro
      - ./.env.local:/app/.env:rw
      - php-socket:/etc/nginx/php/sock:rw
      - ./docker/nginx/nginx.conf:/etc/nginx/conf.d/default.conf:ro

  api:
    build:
      context: docker/php
      args:
        USER_ID: ${USER_ID}
        GROUP_ID: ${GROUP_ID}
    container_name: mycelium-api
    volumes:
      - ./backend:/app:rw
      - ./shared:/app/shared:ro
      - ./.env.local:/app/.env:rw
      - php-socket:/etc/php/sock:rw
    extra_hosts:
      - host.docker.internal:host-gateway
    env_file: .env.local

  queues:
    build:
      context: docker/php
      dockerfile: Dockerfile.queue
      args:
        USER_ID: ${USER_ID}
        GROUP_ID: ${GROUP_ID}
    container_name: mycelium-queues
    volumes:
      - ./backend:/app:rw
      - ./shared:/app/shared:ro
      - ./.env.local:/app/.env:rw
      - php-socket:/etc/php/sock:rw
    extra_hosts:
      - host.docker.internal:host-gateway
    env_file: .env.local
    depends_on:
      - localstack

  frontend:
    build:
      context: docker/node
      args:
        USER_ID: ${USER_ID:-1000}
        GROUP_ID: ${GROUP_ID:-1000}
    container_name: mycelium-frontend
    ports:
      - "8001:8001"
    volumes:
      - ./frontend:/app:delegated
      - ./shared:/app/shared:ro
      - ./.env.local:/app/.env.local:rw
    env_file: .env.local

  localstack:
    image: localstack/localstack:4.9
    container_name: mycelium-localstack
    ports:
      - "8799:8799"
      - "4566:4566"
      - "4510-4559:4510-4559"
    environment:
      DEBUG: "0"
      SERVICES: "sqs"
      AWS_DEFAULT_REGION: "${AWS_REGION:-us-east-1}"
      AWS_REGION: "${AWS_REGION:-us-east-1}"
      LOCALSTACK_HOST: "${LOCALSTACK_URL:-host.docker.internal}"
      SKIP_SSL_CERT_DOWNLOAD: "1"
      PERSISTENCE: "1"
    volumes:
      - ./docker/localstack:/var/lib/localstack:rw
      - /var/run/docker.s1ock:/var/run/docker.sock:rw
    env_file:
      - ./.env.local
    networks:
      default:
        aliases:
          - ${LOCALSTACK_URL:-localstack}
          - sqs.us-east-1.${LOCALSTACK_URL:-localstack}

  ###> doctrine/doctrine-bundle ###
  database:
    image: postgres:18-alpine
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-app}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-!ChangeMe!}
      POSTGRES_USER: ${POSTGRES_USER:-app}
      POSTGRES_CHARSET: ${POSTGRES_CHARSET:-utf8}
    ports:
      - "5432:5432"
    volumes:
      - ./docker/database:/var/lib/postgresql/18/docker
  ###< doctrine/doctrine-bundle ###

  redis:
    image: redis:8.2-alpine
    container_name: mycelium-redis
    volumes:
      - ./docker/redis/data/redis:/data
    ports:
      - "6379:6379"

  ###> symfony/mailer ###
  mailer:
    image: axllent/mailpit:v1.27
    container_name: mycelium-mail
    ports:
      - "1025:1025"
      - "8025:8025"
    environment:
      MP_SMTP_AUTH_ACCEPT_ANY: "1"
      MP_SMTP_AUTH_ALLOW_INSECURE: "1"
  ###< symfony/mailer ###

volumes:
  php-socket:
